
## Архитектура UserService как отдельного микросервиса

Чтобы спроектировать UserService как отдельный микросервис, обеспечивая управление идентификацией в нескольких микросервисах, необходимо следовать структурированному подходу. Основной сервис здесь — проект **Bets**.

### 1. Структура решений и проектов

#### **UserService Solution**
- **UserService.Api**: Этот проект будет предоставлять функционал UserService через RESTful API.
- **UserService.Application**: Этот проект будет содержать логику приложения, интерфейсы сервисов и DTO.
- **UserService.Core**: Этот проект будет содержать основные сущности и бизнес-логику.
- **UserService.Infrastructure**: Этот проект будет заниматься доступом к данным, конфигурацией IdentityServer4 и другими инфраструктурными аспектами.

#### **IdentityServer Solution**
- **IdentityServer.Api**: Этот проект будет хостить IdentityServer4, отвечающий за выдачу JWT токенов и обработку аутентификации и авторизации.

#### **Bets Solution**
- **Bets.Core**: Основной проект, содержащий сущности и сценарии использования.
- **Bets.Application**: Содержит интерфейсы и классы, которые связывают сценарии использования и инфраструктурные компоненты.
- **Bets.Infrastructure**: Содержит реализацию доступа к данным, внешние сервисы и инфраструктурные компоненты.
- **Bets.Api**: Веб-API проект, отвечающий за взаимодействие с пользователем через HTTP-запросы.
- **Bets.UI**: Проект на React, реализующий клиентскую часть веб-приложения.
- **Bets.Tests**: Проект для модульного и интеграционного тестирования всех слоев приложения.

### 2. Как проекты связаны

1. **Интеграция UserService и IdentityServer**:
   - **IdentityServer.Api**: Конфигурация IdentityServer4 для работы с хранилищем пользователей UserService.
   - **UserService.Infrastructure**: Реализация хранилища пользователей, хранилища ролей и других необходимых хранилищ для использования IdentityServer4.

2. **Bets взаимодействует с UserService**:
   - **Bets.Api**: Выполнение HTTP-запросов к UserService.Api для управления пользователями.
   - **Bets.Infrastructure**: Конфигурация middleware для аутентификации, чтобы проверять JWT токены, выданные IdentityServer4.

### 3. Как это работает

#### **UserService**

1. **Управление пользователями**:
   - **UserService.Api**: Предоставляет конечные точки для регистрации пользователей, входа в систему, управления профилем и т.д.
   - **UserService.Application**: Содержит логику для обработки операций с пользователями и вызовов к инфраструктурному слою.
   - **UserService.Core**: Определяет сущности пользователей, ролей и другую основную бизнес-логику.
   - **UserService.Infrastructure**: Реализует доступ к данным и интегрируется с IdentityServer4 для аутентификации и авторизации.

#### **IdentityServer**

1. **Выдача токенов**:
   - **IdentityServer.Api**: Хостит IdentityServer4, настроенный для выдачи JWT токенов для аутентифицированных пользователей.
   - **IdentityServer.Api**: Взаимодействует с UserService для проверки учетных данных пользователей и управления токенами.

#### **Bets**

1. **Аутентификация и авторизация пользователей**:
   - **Bets.Api**: Защищен с помощью middleware для аутентификации JWT токенов, проверяя их с помощью IdentityServer.
   - **Bets.Application**: Использует API UserService для операций, связанных с пользователями.
   - **Bets.Infrastructure**: Настроен для обработки операций с базой данных, кэширования и других инфраструктурных задач.

### Пример рабочего процесса

1. **Регистрация пользователя**:
   - Пользователь регистрируется через UserService.Api.
   - UserService.Api обрабатывает регистрацию, сохраняет данные пользователя и взаимодействует с IdentityServer.Api для управления идентичностью пользователя.

2. **Вход пользователя в систему**:
   - UserService.Api проверяет учетные данные пользователя и запрашивает у IdentityServer.Api выдачу JWT токена.
   - IdentityServer.Api возвращает JWT токен, который клиент может использовать для аутентифицированных запросов.

3. **Доступ к защищенным ресурсам в Bets**:
   - Клиент отправляет запрос в Bets.Api с JWT токеном.
   - Bets.Api проверяет JWT токен с IdentityServer.Api.
   - Если токен действителен, Bets.Api обрабатывает запрос и может взаимодействовать с UserService.Api для выполнения операций, связанных с пользователями.
